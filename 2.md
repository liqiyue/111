xCAT安装部署

一、	RHEL7.4系统安装
1	选择语言
 
![alt text](image.png)
选择安装过程中所使用的语言，为保证应用兼容性，选择【English】，右侧默认选择【English（United States）】。确定安装语言后，点击【Continue】进入【安装信息摘要】页面。

2	安装信息摘要
 

在【安装信息摘要】页面配置所有与安装相关的信息，如下：
【Keyboard】	选择键盘类型（默认即可）
【Language Support】	选择支持的语言（选择English(United States)）
【Time & Date】	选择时间和时区（选择Asia/Shanghai）
【Installation Source】	选择安装源（默认为本地介质）
【Software Selection】	选择安装模式与安装包
【Installation Destination】	设置系统分区（或者LVM）
【KDUMP】	选择是否开启KDUMP
【Network & Host Name】	配置网络与主机名
【Root Password】	配置root用户密码（必填）
【User Creation】	新建普通用户（必填）

可以点击相应配置项的图标进入配置页面，需要注意的是【Software】和【System】两类配置。安装程序会自动检测各个配置项；如果检测存在无法确认或不正确配置项，相应配置项的图标上会显示感叹号。在该配置界面只有正确进行了全部配置，才能进行下一步操作。
2.1	本地化【Localization】
在本地化【LOCALIZATION】中，为用户提供键盘【Keyboard】、语言支持【Language Support】、时间和日期等三个配置。 

2.1.1	选择时间和日期
在主页面中点击【TIME & DATE】，设定时间与时区：
（1）点击左上【Region】一栏，从下拉列表中选择【Asia】-【Shanghai】来设置时区；
（2）点击右下角，设定日期；点击左下角，设定时间；
（3）如果具有NTP服务器，也可以点击右上角设定NTP服务器地址。
 

配置完毕后，点击左上角【Done】，返回到主页面。

2.2	软件【Software】
在主页面【Software】中，为用户提供了安装源【Installation Source】、软件选择【Software Selection】的配置。
2.2.1	选择安装源
主页面安装源【Installation Source】，主要用于指定RHEL安装介质的位置。使用DVD进行光盘安装时会自动识别安装介质，默认不需要改动。
除了光盘安装，还可以选择ISO文件、网络或USB盘安装，并且可以配置额外软件仓库。
2.2.2	选择安装包
在主页面中点击【Software Selection】，选择安装包。应根据不同业务系统运行的服务器操作系统环境需求，安装程序默认提供了几种【基本环境】安装选择，安装程序默认选项是【Server with GUI】。
 
（1）在左侧【Basic Environment】栏，选择【Minimal Install】。其他安装选择可按生产环境需求而定，包括：
选项	解释说明
Server with GUI	带桌面的服务器
Server	具备通用服务功能的服务器
Minimal Install	（选择此项）最小安装（基本功能）
WorkStation	用于普通PC，带桌面
Custom Operating System	自定义操作系统
Virtualization Host	最小化安装的虚拟化主机
配置完毕后，点击左上角【Done】，返回到主页面。
2.3	系统【System】
在系统【System】中，为用户提供了安装位置【Installation Destination】、【KDUMP】、网络和主机名【Network & Host Name】的配置。
2.3.1	创建硬盘分区
在主页面中点击【Installation Destination】。配置安装磁盘及分区，安装时希望使用全新的磁盘并且使用全部磁盘空间,在此不使用默认自动分区配置，按照规范来新建相关文件系统，因此在左下角【Storage Configuration】选择【Custom】，表示进行自定义分配存储，如下图：

  
选择【Custom】，并点击【Done】，进入【Manual Partitioning】页面，如下图所示：
	左侧下拉菜单栏，保持默认的LVM格式；
	左下角使用“+”进行/boot、VG及LV资源的新建；
（1）创建boot分区
点击【+】，弹出菜单，在【Mount Point】中选择下拉菜单【/boot】，在【Desired Capacity】中手动输入【1 GiB】，最后点击【Add mount point】确认：
 
创建结果如下图，如需修改，可点击右上角【Modify】选项；
（2）创建bootefi分区（UEFI启动模式下）
如果服务器从UEFI模式下启动，需要额外创建/boot/efi分区。
点击【+】，弹出菜单，在【Mount Point】中选择下拉菜单【/boot/efi】，在【Desired Capacity】中手动输入【1 GiB】，最后点击【Add mount point】确认。
（3）创建/分区：
点击【+】，弹出菜单，以根分区为例：
在【Mount Point】中选择下拉菜单【/】，在【Desired Capacity】中手动输入【43 GiB】，最后点击【Add mount point】确认。
（4）创建/home分区
点击【+】，弹出菜单，在【Mount Point】中选择下拉菜单【/home】，在【Desired Capacity】中手动输入【10 GiB】，最后点击【Add mount point】确认。
输入完毕后，点击【Save】保存。
配置挂载点全部创建成功后，点击左上角【Done】确认。
如果首次格式化分区，会提示是否确认，如下图所示，点击【Accept Changes】：
 
后续可根据系统管理员的需求，自行调整。
2.3.2	配置网络与主机名
在主页面中点击【Network & Host Name】,可以后续安装再行修改。如需配置team或者bond，此处不要配置。
 
2.3.3	配置安全
在主页面中点击【Security Policy】,进入后点击【Apply Security policy】,将其置为【OFF】状态，关闭安全策略。
 
2.4	用户【User Settings】
2.4.1	配置root用户密码
配置root用户密码：点击【Root Password】，配置密码。完毕后点击【Done】 
3	开始安装
完成全部配置后，在【安装信息摘要】页面点击【Begin Installation】按钮，就进入自动安装进程。 
安装完毕后，点击【Reboot】重启。
 
二、	配置系统基础服务
1	关闭SElinux服务。
1.1	 SELinux 的状态和模式
目前 SELinux 支持三种模式:
•	enforcing：强制模式，表示SELinux 运行中，且已经正确的开始限制 domain/type 了;
•	permissive：宽容模式，表示SELinux 运行中，不过仅会有警告信息，并不会实际限制 domain/type 的存取。这种模式可以运来作为 SELinux 的 debug 之用;
•	disabled：关闭，SELinux 没有运行。
1.2	SELinux的关闭与启动
[root@RHEL7 ~]# sestatus
SELinux status:                 enabled
[root@RHEL7 ~]# getenforce            //查看selinux运行模式，默认为Enforcing
Enforcing
[root@RHEL7 ~]# setenforce 0          //临时修改selinux模式为Permissive
[root@RHEL7 ~]# setenforce 1          //临时修改selinux模式为Enforcing
//永久修改，需要重启系统生效
[root@RHEL7 ~]# sed -i 's/=enforcing/=disabled/' /etc/selinux/config
[root@RHEL7 ~]# reboot
[root@RHEL7 ~]# getenforce 
Disabled
2	关闭Firewalld服务
systemctl stop firewalld                //临时关闭，重启恢复
systemctl disable firewalld             //永久关闭firewalld
3	配置固定IP地址
[root@xCAT ~]# cat /etc/sysconfig/network-scripts/ifcfg-ens34
TYPE=Ethernet
PROXY_METHOD=none
BROWSER_ONLY=no
BOOTPROTO=static
DEFROUTE=yes
IPV4_FAILURE_FATAL=no
IPV6INIT=yes
IPV6_AUTOCONF=yes
IPV6_DEFROUTE=yes
IPV6_FAILURE_FATAL=no
IPV6_ADDR_GEN_MODE=stable-privacy
NAME=ens34
UUID=472760b7-c4cf-45a0-a4f4-b5cda6a3a6b6
DEVICE=ens34
ONBOOT=yes
IPADDR=192.168.15.7
NETMASK=255.255.255.0
PREFIX=24
[root@xCAT ~]# systemctl restart network
4	配置域名
[root@xCAT-RHEL7 ~]# domainname hpc            //临时域名
[root@xCAT-RHEL7 ~]# vi /etc/rc.d/rc.local      //永久域名
[root@xCAT-RHEL7 ~]# cat /etc/rc.d/rc.local
#!/bin/bash
# THIS FILE IS ADDED FOR COMPATIBILITY PURPOSES
#
# It is highly advisable to create own systemd services or udev rules
# to run scripts during boot instead of using this file.
#
# In contrast to previous versions due to parallel execution during boot
# this script will NOT be run after all other services.
#
# Please note that you must run 'chmod +x /etc/rc.d/rc.local' to ensure
# that this script will be executed during boot.

touch /var/lock/subsys/local
/bin/domainname hpc
[root@xCAT-RHEL7 ~]# chmod +x /etc/rc.d/rc.local    //给文件可执行的权限
[root@xCAT-RHEL7 ~]# cat /etc/resolv.conf           //设置域名解析器的配置文件
# Generated by NetworkManager
search hpc
nameserver 192.168.15.7
5	设置主机名
[root@xCAT# hostnamectl set-hostname xCAT –static
6	设置network网络文件
[root@xCAT ~]# vi /etc/sysconfig/network
[root@xCAT ~]# cat /etc/sysconfig/network
# Created by anaconda
NETWORKING=yes
HOSTNAME=xCAT
DOMAINNAME=hpc
7	禁用network使用NetworkManager
[root@xCAT ~]# systemctl disable network
network.service is not a native service, redirecting to /sbin/chkconfig.
Executing /sbin/chkconfig network off
systemctl enable NetworkManager
[root@xCAT ~]# systemctl enable NetworkManager
[root@xCAT ~]# reboot

8	配置本地YUM源
[root@RHEL7 ~]# yum clean all
Updating Subscription Management repositories.
Unable to read consumer identity
This system is not registered with an entitlement server. You can use subscription-manager to register.      //yum提示没有注册，我们可以使用本地源
13 files removed
[root@RHEL7 ~]# vi /etc/yum/pluginconf.d/subscription-manager.conf
[main]
enabled=0              //改为0，禁用提示

3.1	上传ISO镜像到系统中
[root@RHEL7 ~]# ll
total 11196420
-rw-------. 1 root root        1811 Jan 13 22:48 anaconda-ks.cfg
-rw-r--r--  1 root root 11465129984 Nov 30 17:57 rhel-server-7.4-x86_64-dvd.iso
[root@RHEL7 ~]# mkdir /iso
[root@RHEL7 ~]# mv rhel-server-7.4-x86_64-dvd.iso /iso
3.2	将镜像挂载到本地
[root@RHEL7 ~]# mkdir /isos
[root@RHEL7 ~]# mount -t iso9660 -o loop /iso/server-7.4-x86_64-dvd.iso /isos
mount: /yum: WARNING: device write-protected, mounted read-only.
这样挂载的yum在重启后将会失效，可以使用fstab将yum源改为永久本地源
 
3.3	创建repo文件
[root@RHEL7 ~]# vi /etc/yum.repos.d/local.repo
[BaseOS]
name=BaseOS
baseurl=file:///isos
gpgcheck=0
enabled=1
 
三、	xCAT安装
上传xcat安装包，因系统不识别bz2格式的压缩包，需要先安装bzip2
[root@RHEL7 ~]# yum -y install bzip2
1	创建目录解压文件
[root@RHEL7 ]# mkdir /Xcat
[root@RHEL7 ]# tar -jxvf xcat-core-2.16.5-linux.tar.bz2 -C /Xcat/
[root@RHEL7 ]# tar -jxvf xcat-dep-2.16.5-linux.tar.bz2 -C /Xcat/
[root@RHEL7 Xcat]# ll /Xcat
total 8
drwxrwxr-x 3 root   root   4096 Mar  3  2023 xcat-core
drwxrwsr-x 7 159320 311656 4096 Jan 14 00:07 xcat-dep
2	生成xCAT的repo文件并安装
[root@RHEL7 xcat-core]# ./mklocalrepo.sh 
/Xcat/xcat-core
[root@RHEL7 xcat-core]# cd /Xcat/xcat-dep/rh7x86_64/
[root@RHEL7 x86_64]# ./mklocalrepo.sh
[root@RHEL7 ]# ll /etc/yum.repos.d/
total 12
-rw-r--r-- 1 root root 147 Jan 13 23:41 local.repo
-rw-r--r-- 1 root root 144 Jan 14 00:08 xcat-core.repo
-rw-r--r-- 1 root root 161 Jan 14 00:12 xcat-dep.repo
[root@RHEL7 ]# yum clean metadata
[root@RHEL7 ]# yum makecache
[root@RHEL7 ]# yum install -y xCAT
安装完成后检查xCAT安装是否正常
[root@RHEL7 ~]# source /etc/profile.d/xcat.sh 
[root@RHEL7 ~]# tabdump site
  
四、	配置xCAT的相关服务
1	设置集群hosts表
计算机点的IP地址和主机名按需求添加进去
[root@xCAT ~]# cat /etc/hosts
127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
::1         localhost localhost.localdomain localhost6 localhost6.localdomain6
##############OS Network##################
192.168.15.11 node1
192.168.15.12 node2
192.168.15.13 node3
##############IPMI Network##################
192.168.16.11 node1bmc
192.168.16.12 node2bmc
192.168.16.13 node3bmc
2	配置site表信息（domain、dhcp、ntp）
[root@xCAT ~]# chdef -t site dhcpinterfaces='master | ens34' domain=hpc ntpservers=192.168.15.7
3	配置networks表信息（dhcp、tftp、dns、ntp、log）
[root@xCAT ~]# chdef -t network -o 192_168_15_0-255_255_255_0 dhcpserver=192.168.15.7 tftpserver=192.168.15.7 nameservers=192.168.15.7 ntpservers=192.168.15.7 logservers=192.168.15.7
4	配置node计算机点的信息（nodelist、nodetype、noderes、mac）
[root@xCAT ~]# tabdump nodelist
#node,groups,status,statustime,appstatus,appstatustime,primarysn,hidden,updatestatus,updatestatustime,zonename,comments,disable
"node1","compute,levo,all",,,,,,,,,,,
"node2","compute,levo,all",,,,,,,,,,,
"node3","compute,levo,all",,,,,,,,,,,
[root@xCAT ~]# tabdump nodetype
#node,os,arch,profile,provmethod,supportedarchs,nodetype,comments,disable
"node1","centos7.4","x86_64","compute",,,,,
"node2","centos7.4","x86_64","compute",,,,,
"node3","centos7.4","x86_64","compute",,,,,
[root@xCAT ~]# tabdump noderes
#node,servicenode,netboot,tftpserver,tftpdir,nfsserver,monserver,nfsdir,installnic,primarynic,discoverynics,cmdinterface,xcatmaster,current_osimage,next_osimage,nimserver,routenames,nameservers,proxydhcp,syslog,comments,disable
"levo",,"xnba","192.168.15.7",,"192.168.15.7",,,"ens34","ens34",,,"192.168.15.7",,,,,,,,,
[root@xCAT ~]# tabdump mac
#node,interface,mac,comments,disable
"node1",,"00:50:56:31:87:03",,
"node2",,"00:50:56:28:5E:FA",,
"node3",,"00:50:56:2B:75:0E",,
[root@xCAT ~]# tabdump passwd
#key,username,password,cryptmethod,authdomain,comments,disable
"system","root","111111",,,,
"bmc","USERID","PASSW0RD",,,,
[root@xCAT ~]# tabdump ipmi
#node,bmc,bmcport,taggedvlan,bmcid,username,password,comments,disable
"levo","/\z/bmc/",,,,,,,
[root@xCAT ~]# tabdump mp
#node,mpa,id,nodetype,comments,disable
"compute","compute",,,,
[root@xCAT ~]# tabdump mpa
#mpa,username,password,displayname,slots,urlpath,comments,disable
"compute","admin","admin",,,,,
[root@xCAT ~]# tabdump nodehm
#node,power,mgt,cons,termserver,termport,conserver,serialport,serialspeed,serialflow,getmac,cmdmapping,consoleondemand,consoleenabled,comments,disable
"compute",,"ipmi",,,,,,,,,,,,,
5	创建dns和dhcp
makedns -n
systemctl restart named
makedhcp -n
systemctl restart dhcpd
6	制作镜像并分发系统
[root@xCAT ~]# copycds /iso/rhel-server-7.4-x86_64-dvd.iso 
Copying media to /install/rhels7.4/x86_64
Media copy operation successful
[root@xCAT ~]# lsdef -t osimage
rhels7.4-x86_64-install-compute  (osimage)
rhels7.4-x86_64-install-service  (osimage)
rhels7.4-x86_64-netboot-compute  (osimage)
rhels7.4-x86_64-stateful-mgmtnode  (osimage)
rhels7.4-x86_64-statelite-compute  (osimage)
[root@xCAT ~]# nodeset levo osimage=rhels7.4-x86_64-install-compute /levo为组名
node1: install rhels7.4-x86_64-compute
node2: install rhels7.4-x86_64-compute
node3: install rhels7.4-x86_64-compute
[root@xCAT ~]# lsdef node1 -i status
Object name: node1
    status=booted                      //booted代表已完成
[root@xCAT ~]# pscp /etc/hosts compute:/etc/hosts //将主机上的hosts表批量拷贝到计算节点
7	固定IP添加解析
[root@xCAT ~]# pscp /etc/hosts compute:/etc/hosts 
[root@xCAT ~]# psh compute ""sed -i s/"dhcp"/"static"/g /etc/sysconfig/network-scripts/ifcfg-ens33""
[root@xCAT ~]# psh compute "echo "PREFIX=24" >> /etc/sysconfig/network-scripts/ifcfg-ens33"
[root@xCAT ~]# psh compute "echo "GATEWAY=192.168.15.1" >> /etc/sysconfig/network-scripts/ifcfg-ens33"
[root@xCAT ~]# psh node1 "echo "IPADDR=192.168.15.11" >> /etc/sysconfig/network-scripts/ifcfg-ens33"
[root@xCAT ~]# psh node2 "echo "IPADDR=192.168.15.12" >> /etc/sysconfig/network-scripts/ifcfg-ens33"
[root@xCAT ~]# psh node3 "echo "IPADDR=192.168.15.13" >> /etc/sysconfig/network-scripts/ifcfg-ens33"
检查后再执行下一步，否则会与node断开连接
[root@xCAT ~]# psh compute "systemctl restart network"
[root@xCAT ~]# psh compute "systemctl disable network"
[root@xCAT ~]# psh compute "systemctl enable NetworkManager"
[root@xCAT ~]# psh compute "reboot"
